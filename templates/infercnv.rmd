---
title: "snRNAseq workflow: inferCNV"
date: "`r format(Sys.time(), '%B %d, %Y')`"
geometry: margin=1in
fontfamily: mathpazo
fontsize: 11pt
params:
  params_file: false
  rds_file: false
output:
  html_document:
    keep_md: true
    code_folding: show
    toc: true
    toc_float: true
    toc_collapsed: true
    toc_depth: 4
    number_sections: true
    theme: lumen
---

```{r initialise, include = F}
# magrittr, gridExtra, monocle3 must be loaded in the environment (due to package-specific bugs)
library(gridExtra)
library(monocle3)
library(magrittr)

# load params file
curr_params <- 
  rjson::fromJSON(file = params$params_file) %>% 
  type.convert(as.is = T)

# set seed for repeatability
set.seed(42)
random_seed = 42

# chunk setup
knitr::opts_chunk$set(fig.align = "center",
                      dpi = 300)
```

```{r define_functions, include = F}
# flatten lists
flatten_list <- function (x, use.names = TRUE, classes = "ANY") 
{
    len <- sum(rapply(x, function(x) 1L, classes = classes))
    y <- vector("list", len)
    i <- 0L
    items <- rapply(x, function(x) {
        i <<- i + 1L
        y[[i]] <<- x
        TRUE
    }, classes = classes)
    if (use.names && !is.null(nm <- names(items))) 
        names(y) <- nm
    y
}
```

# Run info {-}

```{r curr_params, echo = F}
curr_params %>%
  flatten_list() %>%
  {tibble::tibble(
    param = names(.), 
    value = purrr::map(., paste, collapse = ", ") %>% unlist() %>% substr(1, 250))
  } %>%
  knitr::kable()
```

# Load object

```{r load_seu}
cds <- readRDS(params$rds_file)
```

# Copy number analysis

## Run `inferCNV`

`r if (!curr_params$reference_samples & !("malignant" %in% SummarizedExperiment::colData(cds)$annotation)) { "inferCNV requires either reference versus query samples or a malignant cluster as a query for CNV analysis. Either final celltype annotations must include 'malignant' cells, or reference sampmles must be provided. Please run the package again with a 'malignant' group specified in order to run inferCNV." }`

```{r exit_if_no_malignant, eval = (curr_params$infercnv$reference_samples == F & !("malignant" %in% SummarizedExperiment::colData(cds)$annotation))}
# truncate document 
knitr::knit_exit()
```

From [**github.com/broadinstitute/inferCNV/wiki**](https://github.com/broadinstitute/inferCNV/wiki)

>  ***InferCNV: Inferring copy number alterations from tumor single cell RNA-Seq data***
>
> *InferCNV is used to explore tumor single cell RNA-Seq data to identify evidence for somatic large-scale chromosomal copy number alterations, such as gains or deletions of entire chromosomes or large segments of chromosomes. This is done by exploring expression intensity of genes across positions of tumor genome in comparison to a set of reference 'normal' cells. A heatmap is generated illustrating the relative expression intensities across each chromosome, and it often becomes readily apparent as to which regions of the tumor genome are over-abundant or less-abundant as compared to that of normal cells.*

```{r get_ref_cts}
if (curr_params$infercnv$reference_celltypes != F) {
  ref_val <- curr_params$infercnv$reference_celltypes
  ref_col <- "annotation"
} else if (curr_params$infercnv$reference_samples != F) {
  ref_val <- curr_params$infercnv$reference_samples
  ref_col <- "sample"
} else if (curr_params$infercnv$reference_celltypes != F & 
           curr_params$infercnv$reference_samples != F){
  # truncate document
  message("Both reference samples and celltypes given. Pick one!")
  knitr::knit_exit()
} else {
  # truncate document
  message("No reference samples or celltypes given!")
  knitr::knit_exit()
}
ref_val <- stringr::str_split(ref_val, ",")[[1]]
```

We annotate all `r paste(paste(ref_val, sep = " and "), ref_col)` as matched normal and use this to infer copy number variants in the malignant population. Unlike CNVs called from bulk genotyping data, `inferCNV` can also reveal subclonal events in the tumour that only occur in some cell lineages, but not others. 

```{r infercnv_annots_sample, eval = ref_col == "sample", include = ref_col == "sample}
# label populations as normal or malignant sample
infercnv_annots <-
  cds %>%
  SummarizedExperiment::colData() %>%
  tibble::as_tibble(rownames = "cell") %>%
  dplyr::transmute(
    cell,
    infercnv_population = dplyr::case_when(
      sample %in% ref_val ~ sample,
      TRUE ~ paste0("malignant_", sample))
  ) %>%
  dplyr::group_by(infercnv_population) %>%
  # remove lineages containing only 1 cell
  dplyr::filter(dplyr::n() > 1)
```

```{r infercnv_annots_celltype, eval = ref_col == "annotation", include = ref_col == "annotation"}
# label populations as normal or malignant celltype
infercnv_annots <-
  cds %>%
  SummarizedExperiment::colData() %>%
  tibble::as_tibble(rownames = "cell") %>%
  # only malignant and reference annotations
  dplyr::filter(annotation %in% c("malignant", ref_annots)) %>%
  dplyr::transmute(
     cell,
     infercnv_population = dplyr::case_when(
       annotation == "malignant" ~ paste0("malignant_", sample),
       TRUE ~ annotation)) %>%
    dplyr::group_by(infercnv_population) %>%
    # remove lineages containing only 1 cell
    dplyr::filter(dplyr::n() > 1)
```

```{r infercnv_obj}
# save
infercnv_annots %>%
  readr::write_tsv("infercnv_annots.tsv", col_names = F)

# create infercnv object
infercnv_obj <- xfun::cache_rds({
  infercnv::CreateInfercnvObject(
    raw_counts_matrix = as.matrix(cds@assays@data$counts),
    annotations_file = "infercnv_annots.tsv",
    gene_order_file = curr_params$infercnv$gene_order_file,
    ref_group_names = ref_val
  )
}, file = "infercnv_obj_prelim.rds")
 
# perform infercnv operations to reveal cnv signal
dir.create("infercnv/")
options(scipen = 100)
infercnv_obj <- xfun::cache_rds({
 infercnv::run(
   infercnv_obj,
   cutoff = 0.1,
   out_dir = "infercnv/",
   cluster_by_groups = T,
   denoise = T,
   HMM = T, 
   resume_mode = T,
   analysis_mode = "subclusters"
 )
}, file = "infercnv_obj.rds")
```

```{r save}
saveRDS(infercnv_obj, "infercnv.rds")
```