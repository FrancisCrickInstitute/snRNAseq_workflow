---
title: "snRNAseq workflow: integration"
date: "`r format(Sys.time(), '%B %d, %Y')`"
geometry: margin=1in
fontfamily: mathpazo
fontsize: 11pt
params:
  rds_files: false
  cache_dir: false
  malignancy_score_file: false
output:
  html_document:
  keep_md: true
code_folding: show
toc: true
toc_float: true
toc_collapsed: true
toc_depth: 4
number_sections: true
theme: lumen
---

```{r initialise, include = F}
# pipe
library(magrittr)

# ggplot presets
ggplot2::theme_set(ggplot2::theme_bw())
ggplot2::theme_update(legend.text = ggplot2::element_text(size = 7))
ditto_colours <- list(ggplot2::scale_fill_manual(values = dittoSeq::dittoColors(), na.value = "white"),
                      ggplot2::scale_colour_manual(values = dittoSeq::dittoColors(), na.value = "white"))

# functions
get_fig_dims <- function(n_plots, n_cols = NULL, grid_width = 10, height_to_width_ratio = 1) {
  # get dims
  dims <- ggplot2::wrap_dims(n_plots, n_cols)
  # get scale
  scale <- grid_width / dims[1]
  # get height
  grid_height <- (dims[2] * scale) * height_to_width_ratio
  dims <- c(grid_width, grid_height)
  # if any dim is 0, make 1 to avoid error
  dims[dims == 0] <- 1
  # return dims
  dims
}

# chunk setup
knitr::opts_chunk$set(fig.align = "center",
                      dpi = 300,
                      cache.path = params$cache_dir)
```

```{r load}
# read files
seu_ls <-
  strsplit(params$rds_files , ",")[[1]] %>%
  lapply(readRDS)

# remove objects containing <= 5 cells
seu_ls <- seu_ls[unlist(lapply(seu_ls, ncol)) > 5]
```

## Integration

```{r combine}
if (length(seu_ls) > 1) { 
  seu <- Reduce(merge, seu_ls) 
  redu <- "mnn"
} else { 
  seu <- seu_ls[[1]] 
  redu <- "pca"
} 
```

```{r hvgs}
seu <- xfun::cache_rds({
  seu <- Seurat::NormalizeData(seu)
  seu <- Seurat::FindVariableFeatures(seu, selection.method = "vst", nfeatures = 2000)
  seu
}, file = "seu_hvgs.rds")
```

```{r integrate}
seu <- xfun::cache_rds({
  if (dplyr::n_distinct(seu$sample) > 1) {
    seu <- SeuratWrappers::RunFastMNN(object.list = Seurat::SplitObject(seu, split.by = "sample"))
  } else {
    seu <- Seurat::SCTransform(seu)
    seu <- Seurat::RunPCA(seu, npcs = ifelse(ncol(seu) <= 50, ncol(seu) - 1, 50))
  }
  seu
}, file = "seu_mnn.rds")
```

## UMAP and clustering

```{r cluster}
seu <- xfun::cache_rds({
  seu <- Seurat::RunUMAP(seu, reduction = redu, dims = 1:30)
  seu <- Seurat::FindNeighbors(seu, reduction = redu, dims = 1:30)
  seu <- Seurat::FindClusters(seu, reduction = redu, resolution = 0.3)
  seu
}, file = "seu_clustered.rds")
```

```{r cluster_markers}
markers <- xfun::cache_rds({
  markers <- Seurat::FindAllMarkers(seu, only.pos = TRUE, min.pct = 0.25, logfc.threshold = 0.25)
  markers
}, file = "markers.rds") 
do_heatmap <- length(intersect(markers$gene, rownames(seu))) > 0
```

```{r sample_umap}
p <- Seurat::DimPlot(seu, group.by = "sample", raster = F) +
  ditto_colours +
  ggplot2::coord_fixed()
p
```

```{r cluster_umap}
p <- Seurat::DimPlot(seu, raster = F) +
  ditto_colours +
  ggplot2::coord_fixed()
p
```

```{r plot_cluster_markers, eval = do_heatmap == T, fig.height = 10}
top10 <-
  markers %>%
  dplyr::group_by(cluster) %>%
  dplyr::top_n(n = 10, wt = avg_log2FC) 
p <- 
  Seurat::DoHeatmap(seu, features = top10$gene) +
  Seurat::NoLegend()
p
```

## Groupings vs reductions

```{r get_groupings, include = F, echo = F}
# sample_metadata columns with >1 value that are not `dir` or `file_prefix`
groupings <- 
  seu@misc$sample_metadata %>%
  dplyr::select(where(~ dplyr::n_distinct(.x) > 1)) %>%
  dplyr::select(-tidyr::any_of(c("dir", "file_prefix"))) %>%
  colnames()
```

```{r groupings_vs_reductions, echo = F, fig.dim = get_fig_dims(n_plots = 3 * length(groupings), n_cols = 3), fig.cap = "Plot of all monocle3 dimensionality reductions, coloured by groupings", eval = (nrow(seu@misc$sample_metadata) > 1) == T}
# plot all groupings vs all reductions
groupings_vs_reductions <- list()
purrr::walk(groupings, function(grouping) {
  purrr::walk(redus, function(redu) {
    if (dplyr::n_distinct(seu@meta.data[, grouping]) > 1) {
      title <- paste0(redu, "_vs_", grouping)
      p <- 
        Seurat::DimPlot(
          seu, 
          group.by = grouping, 
          reduction = tolower(redu),
          cols = dittoSeq::dittoColors(),
          raster = F
        )
      groupings_vs_reductions[[paste0(grouping, "_legend")]] <<-
        lemon::g_legend(p)
      groupings_vs_reductions[[title]] <<- 
        p & Seurat::NoLegend()
    }
  })
})
# create grob layout
p <-
  gridExtra::marrangeGrob(
    grobs = groupings_vs_reductions,
    nrow = length(groupings),
    ncol = length(redus) + 1,
    layout_matrix = matrix(
      1:length(groupings_vs_reductions),
      length(groupings),
      length(redus) + 1,
      TRUE
    ),
    top = NULL
  )
p
```

## Malignancy and differentiation scores (from Zhang et al., 2021)

```{r malig_and_diff_scores}
# switch default assay to RNA
Seurat::DefaultAssay(seu) <- "RNA"
malignancy_genes <-
  readr::read_tsv(params$malignancy_score_file) %>%
  dplyr::transmute(gene, 
                   population = dplyr::case_when(logFC > 0 ~ "malignant",
                                                 TRUE ~ "nonmalignant")) %>%
  {split(.$gene, .$population)} %>%
  {c(., list("differentiation" = c("KRT20", "PHGR1", "MDK", "CHDR2", "RARRES3", "GPA33", "SLC5A1", "MUC13")))}
seu <- 
  Seurat::AddModuleScore(
    seu, 
    assay = "RNA", 
    features = malignancy_genes, 
    name = names(malignancy_genes)
  )

# malignancy score = malignant score - nonmalignant score
seu$malignancy <- seu$malignant1 - seu$nonmalignant2

# differentiation score
seu$differentiation <- seu$differentiation3
seu$differentiation3 <- NULL
```

```{r malig_and_diff_plots, echo = F, fig.dim = c(10, 5)}
Seurat::FeaturePlot(seu, features = c("malignancy", "differentiation")) & 
  ggplot2::scale_colour_gradientn(colours = rev(RColorBrewer::brewer.pal(n = 11, name = "RdBu")))
```

## Save

```{r save}
# save
saveRDS(seu, "seu.rds")
```

